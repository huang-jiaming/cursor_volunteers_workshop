<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pomodoro</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>&#x1F345;</text></svg>">
  <style>
    :root {
      --bg: #f8f9fc;
      --bg-focus: #f0f4ff;
      --bg-break: #ecfdf5;
      --bg-paused: #fefce8;
      --card: #ffffff;
      --text: #111827;
      --text-secondary: #4b5563;
      --muted: #9ca3af;
      --border: #e5e7eb;
      --accent: #2563eb;
      --accent-soft: #dbeafe;
      --accent-glow: rgba(37, 99, 235, 0.15);
      --green: #059669;
      --green-soft: #d1fae5;
      --green-glow: rgba(5, 150, 105, 0.15);
      --amber: #d97706;
      --amber-soft: #fef3c7;
      --amber-glow: rgba(217, 119, 6, 0.15);
      --red: #dc2626;
      --red-soft: #fee2e2;
      --ring-size: 300px;
      --radius: 1rem;
      --radius-sm: 0.625rem;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      min-height: 100vh;
      min-height: 100dvh;
      transition: background-color 1s ease;
      -webkit-font-smoothing: antialiased;
    }

    body.state-working { background: var(--bg-focus); }
    body.state-break { background: var(--bg-break); }
    body.state-paused { background: var(--bg-paused); }

    .app {
      width: min(480px, 90%);
      margin: 0 auto;
      padding: 2.5rem 0 4rem;
    }

    /* ---- Header ---- */
    .app-header {
      text-align: center;
      margin-bottom: 2rem;
    }
    .app-header h1 {
      font-size: 1.25rem;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: var(--text-secondary);
    }

    /* ---- Cards ---- */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.02);
      margin-bottom: 0.75rem;
    }
    .card-flush {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.02);
      margin-bottom: 0.75rem;
    }
    .card-section {
      padding: 1.25rem 1.5rem;
    }
    .card-section + .card-section {
      border-top: 1px solid var(--border);
    }
    .card h2 {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
      margin-bottom: 0.75rem;
    }

    /* ---- Screen transitions ---- */
    .screen { display: none; }
    .screen.active {
      display: block;
      animation: screenIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }
    @keyframes screenIn {
      from { opacity: 0; transform: translateY(12px) scale(0.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    /* ---- Setup Form ---- */
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }
    .form-group label {
      display: block;
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 0.3rem;
    }
    .form-group input {
      width: 100%;
      padding: 0.5rem 0.65rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 0.9rem;
      color: var(--text);
      background: var(--bg);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .form-group input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }

    /* ---- Big Slider ---- */
    .slider-hero {
      text-align: center;
      padding: 2rem 0 0.75rem;
      user-select: none;
    }
    .slider-value {
      font-size: 4.5rem;
      font-weight: 800;
      line-height: 1;
      letter-spacing: -0.04em;
      color: var(--text);
      transition: color 0.3s;
    }
    .slider-context {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: 0.5rem;
      min-height: 1.3em;
      transition: opacity 0.2s;
    }
    .slider-wrap {
      padding: 1rem 0.5rem 0;
    }
    .slider-wrap input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: linear-gradient(to right, var(--accent-soft), var(--accent-soft));
      background-size: var(--slider-fill, 50%) 100%;
      background-repeat: no-repeat;
      outline: none;
    }
    .slider-wrap input[type="range"]::-webkit-slider-runnable-track {
      height: 6px;
      border-radius: 3px;
      background: var(--border);
    }
    .slider-wrap input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--accent);
      cursor: grab;
      border: 4px solid var(--card);
      box-shadow: 0 2px 8px rgba(37,99,235,0.35), 0 0 0 1px rgba(37,99,235,0.1);
      margin-top: -19px;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .slider-wrap input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 16px rgba(37,99,235,0.4), 0 0 0 1px rgba(37,99,235,0.15);
    }
    .slider-wrap input[type="range"]::-webkit-slider-thumb:active {
      cursor: grabbing;
      transform: scale(1.05);
    }
    .slider-wrap input[type="range"]::-moz-range-track {
      height: 6px;
      border-radius: 3px;
      background: var(--border);
      border: none;
    }
    .slider-wrap input[type="range"]::-moz-range-progress {
      height: 6px;
      border-radius: 3px;
      background: var(--accent-soft);
    }
    .slider-wrap input[type="range"]::-moz-range-thumb {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--accent);
      cursor: grab;
      border: 4px solid var(--card);
      box-shadow: 0 2px 8px rgba(37,99,235,0.35);
    }
    .slider-ticks {
      display: flex;
      justify-content: space-between;
      padding: 0.4rem 0 0;
      font-size: 0.65rem;
      font-weight: 500;
      color: var(--muted);
      letter-spacing: 0.02em;
    }

    /* ---- Collapsible settings ---- */
    .collapse-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      width: 100%;
      padding: 0.85rem 1.5rem;
      border: none;
      border-top: 1px solid var(--border);
      background: none;
      color: var(--muted);
      font-size: 0.78rem;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      transition: color 0.2s, background 0.15s;
    }
    .collapse-toggle:hover {
      color: var(--text-secondary);
      background: var(--bg);
    }
    .collapse-toggle .chevron {
      display: inline-block;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-size: 0.55rem;
    }
    .collapse-toggle.open .chevron {
      transform: rotate(180deg);
    }
    .collapse-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.35s ease;
      opacity: 0;
    }
    .collapse-body.open {
      max-height: 400px;
      opacity: 1;
    }
    .collapse-inner {
      padding: 0.75rem 1.5rem 1rem;
    }

    /* ---- Buttons ---- */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      border: 1px solid transparent;
      border-radius: var(--radius-sm);
      padding: 0.7rem 1.2rem;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      font-family: inherit;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:hover { filter: brightness(0.96); }
    .btn:active { transform: scale(0.97); }

    .btn-primary {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 1px 3px rgba(37,99,235,0.3);
    }
    .btn-primary:hover {
      box-shadow: 0 4px 12px rgba(37,99,235,0.3);
    }
    .btn-primary.btn-large {
      padding: 1rem 1.5rem;
      font-size: 1.05rem;
      font-weight: 600;
      border-radius: var(--radius);
    }
    .btn-secondary {
      background: var(--bg);
      color: var(--text-secondary);
      border-color: var(--border);
    }
    .btn-ghost {
      background: none;
      color: var(--muted);
      padding: 0.5rem 0.8rem;
      font-size: 0.8rem;
    }
    .btn-ghost:hover { color: var(--red); background: var(--red-soft); }
    .btn-success {
      background: var(--green);
      color: #fff;
      box-shadow: 0 1px 3px rgba(5,150,105,0.3);
    }

    .btn-full { width: 100%; }
    .btn-group {
      display: flex;
      gap: 0.5rem;
    }
    .btn-group .btn { flex: 1; }

    .cta-wrap {
      margin-top: 1rem;
    }

    /* ---- Timer Display ---- */
    .timer-stage {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1.5rem 0 1rem;
    }

    .ring-wrap {
      position: relative;
      width: var(--ring-size);
      height: var(--ring-size);
      margin-bottom: 1.5rem;
      filter: drop-shadow(0 0 0 transparent);
      transition: filter 0.6s ease;
    }
    .ring-wrap.glow-focus { filter: drop-shadow(0 0 24px var(--accent-glow)); }
    .ring-wrap.glow-break { filter: drop-shadow(0 0 24px var(--green-glow)); }
    .ring-wrap.glow-warning { filter: drop-shadow(0 0 24px var(--amber-glow)); }

    .ring-svg {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg);
    }

    .ring-bg {
      fill: none;
      stroke: var(--border);
      stroke-width: 8;
    }
    .ring-progress {
      fill: none;
      stroke: var(--accent);
      stroke-width: 8;
      stroke-linecap: round;
      transition: stroke-dashoffset 1s linear, stroke 0.8s ease;
    }
    .ring-progress.break { stroke: var(--green); }
    .ring-progress.warning { stroke: var(--amber); }

    .ring-center {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .timer-digits {
      font-size: 3.8rem;
      font-weight: 800;
      font-variant-numeric: tabular-nums;
      letter-spacing: -0.03em;
      line-height: 1;
      color: var(--text);
    }

    .timer-label {
      font-size: 0.85rem;
      font-weight: 600;
      margin-top: 0.4rem;
      letter-spacing: 0.02em;
    }
    .timer-label.focus-label { color: var(--accent); }
    .timer-label.break-label { color: var(--green); }
    .timer-label.paused-label { color: var(--amber); }

    /* Pulse when paused */
    .paused .timer-digits {
      animation: pulse 2.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* ---- Cycle dots ---- */
    .cycle-dots {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      flex-wrap: wrap;
    }
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--border);
      transition: all 0.3s ease;
    }
    .dot.completed { background: var(--accent); }
    .dot.current {
      background: var(--accent);
      transform: scale(1.4);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }

    /* ---- Session progress bar ---- */
    .session-bar {
      padding: 0 1.5rem 1.25rem;
    }
    .session-bar-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      font-weight: 500;
      color: var(--muted);
      margin-bottom: 0.4rem;
    }
    .session-bar-track {
      width: 100%;
      height: 3px;
      background: var(--border);
      border-radius: 2px;
      overflow: hidden;
    }
    .session-bar-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 2px;
      transition: width 1s linear;
    }

    /* ---- Timer controls ---- */
    .timer-controls {
      padding: 0 1.5rem 1.5rem;
    }
    .controls-primary {
      margin-bottom: 0.5rem;
    }
    .controls-secondary {
      display: flex;
      gap: 0.5rem;
    }
    .controls-secondary .btn { flex: 1; }

    /* ---- Auto-start overlay ---- */
    .auto-start-bar {
      display: none;
      text-align: center;
      padding: 0.75rem 1.5rem;
      background: var(--accent-soft);
      font-size: 0.85rem;
      color: var(--accent);
      font-weight: 500;
      border-top: 1px solid var(--border);
    }
    .auto-start-bar.visible { display: block; }
    .auto-start-bar a {
      color: var(--accent);
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      border-bottom: 1px solid currentColor;
    }
    .auto-start-bar a:hover { opacity: 0.8; }

    /* ---- Complete Screen ---- */
    .complete-hero {
      text-align: center;
      padding: 2.5rem 1rem 1.5rem;
    }
    .complete-checkmark {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: var(--green-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1.25rem;
      animation: popIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .complete-checkmark svg {
      width: 32px;
      height: 32px;
      color: var(--green);
    }
    @keyframes popIn {
      from { transform: scale(0); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .complete-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }
    .complete-subtitle {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    .complete-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1px;
      background: var(--border);
      border-top: 1px solid var(--border);
    }
    .stat-cell {
      text-align: center;
      padding: 1rem 0.5rem;
      background: var(--card);
    }
    .stat-cell .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      line-height: 1;
    }
    .stat-cell .stat-label {
      font-size: 0.65rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
      margin-top: 0.3rem;
    }
    .complete-action {
      padding: 1.25rem 1.5rem;
    }

    /* ---- Stats / History ---- */
    .today-stats {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .today-count {
      font-size: 2.25rem;
      font-weight: 800;
      color: var(--accent);
      line-height: 1;
      min-width: 2.5rem;
      text-align: center;
    }
    .today-detail {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    .today-detail strong {
      color: var(--text);
    }
    .streak-dots {
      display: flex;
      gap: 0.35rem;
      margin-top: 0.65rem;
      flex-wrap: wrap;
    }
    .streak-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--border);
      transition: background 0.3s;
    }
    .streak-dot.filled { background: var(--accent); }

    .empty-state {
      text-align: center;
      padding: 0.5rem 0;
      color: var(--muted);
      font-size: 0.85rem;
    }

    .history-list {
      margin-top: 0.75rem;
      font-size: 0.78rem;
      color: var(--text-secondary);
    }
    .history-row {
      display: flex;
      justify-content: space-between;
      padding: 0.35rem 0;
      border-bottom: 1px solid var(--border);
    }
    .history-row:last-child { border-bottom: none; }

    .clear-link {
      font-size: 0.7rem;
      color: var(--muted);
      cursor: pointer;
      border: none;
      background: none;
      text-decoration: underline;
      font-family: inherit;
      margin-top: 0.5rem;
    }
    .clear-link:hover { color: var(--red); }

    /* ---- Keyboard legend ---- */
    .kb-toggle {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--muted);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
      z-index: 100;
      font-family: inherit;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }
    .kb-toggle:hover { background: var(--bg); color: var(--text-secondary); }

    .kb-legend {
      position: fixed;
      bottom: 3.8rem;
      right: 1rem;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 0.6rem 0.8rem;
      font-size: 0.75rem;
      color: var(--text-secondary);
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      z-index: 100;
      display: none;
    }
    .kb-legend.visible { display: block; animation: screenIn 0.2s ease; }
    .kb-legend div { padding: 0.2rem 0; }
    .kb-legend kbd {
      display: inline-block;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 0.1rem 0.4rem;
      font-size: 0.7rem;
      font-family: inherit;
      min-width: 1.5rem;
      text-align: center;
      font-weight: 500;
    }

    /* ---- Notification permission banner ---- */
    .notif-banner {
      display: none;
      background: var(--accent-soft);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 0.65rem 0.85rem;
      font-size: 0.8rem;
      color: var(--accent);
      margin-bottom: 0.75rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .notif-banner:hover { background: #c7d7fe; }
    .notif-banner.visible { display: block; }

    /* ---- Responsive ---- */
    @media (max-width: 480px) {
      :root { --ring-size: 240px; }
      .timer-digits { font-size: 3rem; }
      .slider-value { font-size: 3.5rem; }
      .complete-stats { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 360px) {
      :root { --ring-size: 200px; }
      .timer-digits { font-size: 2.5rem; }
      .slider-value { font-size: 3rem; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <h1>Pomodoro</h1>
    </header>

    <!-- ==================== SETUP SCREEN ==================== -->
    <div id="screen-setup" class="screen active">
      <div class="card-flush">
        <div class="card-section">
          <div class="slider-hero">
            <div id="sliderValue" class="slider-value">2h</div>
            <div id="sliderContext" class="slider-context"></div>
          </div>
          <div class="slider-wrap">
            <input type="range" id="totalSlider" min="10" max="240" value="120" step="5"
              aria-label="Session duration in minutes">
            <div class="slider-ticks">
              <span>10m</span><span>30m</span><span>1h</span><span>1.5h</span><span>2h</span><span>3h</span><span>4h</span>
            </div>
          </div>
        </div>

        <button class="collapse-toggle" id="settingsToggle"
          aria-expanded="false" aria-controls="settingsBody">
          Customize intervals <span class="chevron">&#9660;</span>
        </button>
        <div class="collapse-body" id="settingsBody" role="region">
          <div class="collapse-inner">
            <div class="form-row">
              <div class="form-group">
                <label for="workDuration">Focus (min)</label>
                <input type="number" id="workDuration" min="1" max="90" value="25" step="1">
              </div>
              <div class="form-group">
                <label for="shortBreak">Short break (min)</label>
                <input type="number" id="shortBreak" min="1" max="30" value="5" step="1">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="longBreak">Long break (min)</label>
                <input type="number" id="longBreak" min="5" max="45" value="15" step="5">
              </div>
              <div class="form-group">
                <label for="longBreakEvery">Long break every</label>
                <input type="number" id="longBreakEvery" min="2" max="10" value="4" step="1">
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="notifBanner" class="notif-banner"
        role="button" tabindex="0"
        aria-label="Enable notifications">
        Enable notifications to get alerts when your focus time ends
      </div>

      <div class="cta-wrap">
        <button class="btn btn-primary btn-large btn-full" id="startBtn">Start Focusing</button>
      </div>

      <div id="statsCard" class="card" style="margin-top:1rem;">
        <h2>Today</h2>
        <div id="todayStats"></div>
        <div id="streakDots" class="streak-dots"></div>
        <div id="historyList" class="history-list"></div>
        <button id="clearHistoryBtn" class="clear-link" style="display:none;">Clear history</button>
      </div>
    </div>

    <!-- ==================== TIMER SCREEN ==================== -->
    <div id="screen-timer" class="screen">
      <div class="card-flush">
        <div class="card-section">
          <div id="cycleDots" class="cycle-dots"></div>
        </div>

        <div class="timer-stage">
          <div id="ringWrap" class="ring-wrap">
            <svg class="ring-svg" viewBox="0 0 200 200">
              <circle class="ring-bg" cx="100" cy="100" r="88"/>
              <circle id="ringProgress" class="ring-progress" cx="100" cy="100" r="88"
                stroke-dasharray="553.00" stroke-dashoffset="553.00"/>
            </svg>
            <div class="ring-center">
              <div id="timerDigits" class="timer-digits">25:00</div>
              <div id="timerLabel" class="timer-label focus-label">Focus</div>
            </div>
          </div>
        </div>

        <div id="autoStartBar" class="auto-start-bar"></div>

        <div class="session-bar">
          <div class="session-bar-label">
            <span id="sessionElapsed">0m elapsed</span>
            <span id="sessionRemaining">2h total</span>
          </div>
          <div class="session-bar-track">
            <div id="sessionBarFill" class="session-bar-fill" style="width:0%"></div>
          </div>
        </div>

        <div class="timer-controls">
          <div class="controls-primary">
            <button class="btn btn-primary btn-full" id="pauseBtn">Pause</button>
          </div>
          <div class="controls-secondary">
            <button class="btn btn-secondary" id="skipBtn">Skip</button>
            <button class="btn btn-ghost" id="endBtn">End Session</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== COMPLETE SCREEN ==================== -->
    <div id="screen-complete" class="screen">
      <div class="card-flush">
        <div class="complete-hero">
          <div class="complete-checkmark">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
          </div>
          <div class="complete-title" id="completeTitle">Nice work!</div>
          <div class="complete-subtitle" id="completeSubtitle">You completed 4 pomodoros</div>
        </div>
        <div class="complete-stats">
          <div class="stat-cell">
            <div class="stat-value" id="completeFocusTime">0m</div>
            <div class="stat-label">Focus</div>
          </div>
          <div class="stat-cell">
            <div class="stat-value" id="completeBreakTime">0m</div>
            <div class="stat-label">Breaks</div>
          </div>
          <div class="stat-cell">
            <div class="stat-value" id="completeTodayTotal">0</div>
            <div class="stat-label">Today</div>
          </div>
        </div>
        <div class="complete-action">
          <button class="btn btn-success btn-full" id="restartBtn">Start Again</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Keyboard shortcut legend -->
  <button class="kb-toggle" id="kbToggle" title="Keyboard shortcuts" aria-label="Show keyboard shortcuts">?</button>
  <div class="kb-legend" id="kbLegend" role="tooltip">
    <div><kbd>Space</kbd> Pause / Resume</div>
    <div><kbd>S</kbd> Skip interval</div>
    <div><kbd>Esc</kbd> End session</div>
  </div>

  <script>
    (function () {
      "use strict";

      // ======== Constants ========
      var STORAGE_KEY = "nick_pomodoro_v1";
      var RING_RADIUS = 88;
      var CIRCUMFERENCE = 2 * Math.PI * RING_RADIUS; // ~553.00

      // ======== DOM refs ========
      var $ = function (id) { return document.getElementById(id); };

      var totalSlider = $("totalSlider");
      var sliderValueEl = $("sliderValue");
      var sliderContext = $("sliderContext");
      var settingsToggle = $("settingsToggle");
      var settingsBody = $("settingsBody");
      var workDurationInput = $("workDuration");
      var shortBreakInput = $("shortBreak");
      var longBreakInput = $("longBreak");
      var longBreakEveryInput = $("longBreakEvery");
      var notifBanner = $("notifBanner");
      var startBtn = $("startBtn");

      var screenSetup = $("screen-setup");
      var screenTimer = $("screen-timer");
      var screenComplete = $("screen-complete");

      var cycleDots = $("cycleDots");
      var ringWrap = $("ringWrap");
      var ringProgress = $("ringProgress");
      var timerDigits = $("timerDigits");
      var timerLabel = $("timerLabel");
      var autoStartBar = $("autoStartBar");
      var sessionElapsed = $("sessionElapsed");
      var sessionRemaining = $("sessionRemaining");
      var sessionBarFill = $("sessionBarFill");
      var pauseBtn = $("pauseBtn");
      var skipBtn = $("skipBtn");
      var endBtn = $("endBtn");

      var completeTitle = $("completeTitle");
      var completeSubtitle = $("completeSubtitle");
      var completeFocusTime = $("completeFocusTime");
      var completeBreakTime = $("completeBreakTime");
      var completeTodayTotal = $("completeTodayTotal");
      var restartBtn = $("restartBtn");

      var todayStatsEl = $("todayStats");
      var streakDotsEl = $("streakDots");
      var historyList = $("historyList");
      var clearHistoryBtn = $("clearHistoryBtn");

      var kbToggle = $("kbToggle");
      var kbLegend = $("kbLegend");

      // ======== State ========
      var session = null;
      var tickInterval = null;
      var autoStartTimeout = null;
      var autoStartCountdown = 0;
      var originalTitle = document.title;

      // ======== Helpers ========
      function todayKey() {
        var d = new Date();
        return d.getFullYear() + "-" +
          String(d.getMonth() + 1).padStart(2, "0") + "-" +
          String(d.getDate()).padStart(2, "0");
      }

      function formatTime(totalSeconds) {
        var s = Math.max(0, Math.round(totalSeconds));
        var m = Math.floor(s / 60);
        var sec = s % 60;
        return String(m).padStart(2, "0") + ":" + String(sec).padStart(2, "0");
      }

      function formatMins(m) {
        m = Math.round(m);
        if (m < 60) return m + "m";
        var h = Math.floor(m / 60);
        var rem = m % 60;
        return rem > 0 ? h + "h " + rem + "m" : h + "h";
      }

      function clamp(val, lo, hi) {
        return Math.max(lo, Math.min(hi, val));
      }

      // ======== localStorage ========
      function loadData() {
        try {
          var raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return { days: {}, prefs: null };
          var p = JSON.parse(raw);
          if (!p || typeof p !== "object") return { days: {}, prefs: null };
          if (!p.days) p.days = {};
          return p;
        } catch (e) {
          return { days: {}, prefs: null };
        }
      }

      function saveData(data) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      }

      function recordSession(cycles, focusMin) {
        var data = loadData();
        var key = todayKey();
        if (!data.days[key]) data.days[key] = { pomodoros: 0, focusMinutes: 0 };
        data.days[key].pomodoros += cycles;
        data.days[key].focusMinutes += focusMin;
        saveData(data);
      }

      function savePrefs() {
        var data = loadData();
        data.prefs = {
          totalMinutes: parseInt(totalSlider.value, 10) || 120,
          workDuration: parseInt(workDurationInput.value, 10) || 25,
          shortBreak: parseInt(shortBreakInput.value, 10) || 5,
          longBreak: parseInt(longBreakInput.value, 10) || 15,
          longBreakEvery: parseInt(longBreakEveryInput.value, 10) || 4
        };
        saveData(data);
      }

      function loadPrefs() {
        var data = loadData();
        if (data.prefs) {
          totalSlider.value = clamp(data.prefs.totalMinutes || 120, 10, 240);
          workDurationInput.value = data.prefs.workDuration || 25;
          shortBreakInput.value = data.prefs.shortBreak || 5;
          longBreakInput.value = data.prefs.longBreak || 15;
          longBreakEveryInput.value = data.prefs.longBreakEvery || 4;
        }
      }

      // ======== Web Audio chime ========
      var audioCtx = null;

      function getAudioCtx() {
        if (!audioCtx) {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        return audioCtx;
      }

      function playChime(type) {
        try {
          var ctx = getAudioCtx();
          var notes, lengths;
          if (type === "warning") {
            notes = [523.25, 523.25];
            lengths = [0.1, 0.1];
          } else if (type === "complete") {
            notes = [523.25, 659.25, 783.99, 1046.5];
            lengths = [0.12, 0.12, 0.12, 0.3];
          } else if (type === "break-end") {
            notes = [440, 523.25, 659.25];
            lengths = [0.1, 0.1, 0.18];
          } else {
            notes = [659.25, 587.33, 523.25];
            lengths = [0.1, 0.1, 0.2];
          }
          var t = ctx.currentTime + 0.05;
          for (var i = 0; i < notes.length; i++) {
            var osc = ctx.createOscillator();
            var gain = ctx.createGain();
            osc.type = "sine";
            osc.frequency.value = notes[i];
            gain.gain.setValueAtTime(0.12, t);
            gain.gain.exponentialRampToValueAtTime(0.001, t + lengths[i]);
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.start(t);
            osc.stop(t + lengths[i] + 0.01);
            t += lengths[i] + 0.04;
          }
        } catch (e) {}
      }

      // ======== Notifications ========
      function checkNotifPermission() {
        if (!("Notification" in window)) return;
        if (Notification.permission === "default") {
          notifBanner.classList.add("visible");
        } else {
          notifBanner.classList.remove("visible");
        }
      }

      function requestNotifPermission() {
        if (!("Notification" in window)) return;
        Notification.requestPermission().then(function () {
          checkNotifPermission();
        });
      }

      function sendNotif(title, body) {
        if (!("Notification" in window) || Notification.permission !== "granted") return;
        try { new Notification(title, { body: body }); } catch (e) {}
      }

      // ======== Cycle Calculation ========
      function calculatePlan() {
        var totalMin = clamp(parseInt(totalSlider.value, 10) || 120, 10, 240);
        var workMin = clamp(parseInt(workDurationInput.value, 10) || 25, 1, 90);
        var shortMin = clamp(parseInt(shortBreakInput.value, 10) || 5, 1, 30);
        var longMin = clamp(parseInt(longBreakInput.value, 10) || 15, 5, 45);
        var longEvery = clamp(parseInt(longBreakEveryInput.value, 10) || 4, 2, 10);

        var intervals = [];
        var elapsed = 0;
        var cycleCount = 0;

        while (true) {
          if (elapsed + workMin > totalMin + 1) break;
          intervals.push({ type: "work", duration: workMin });
          elapsed += workMin;
          cycleCount++;
          if (elapsed >= totalMin) break;
          var isLong = cycleCount % longEvery === 0;
          var breakDur = isLong ? longMin : shortMin;
          if (elapsed + breakDur > totalMin) break;
          intervals.push({ type: isLong ? "long" : "short", duration: breakDur });
          elapsed += breakDur;
        }

        return {
          intervals: intervals,
          totalCycles: cycleCount,
          totalMinutes: elapsed,
          workMinPerCycle: workMin
        };
      }

      // ======== Slider display ========
      function updateSlider() {
        var val = parseInt(totalSlider.value, 10);
        // Display value
        if (val >= 60) {
          var h = Math.floor(val / 60);
          var m = val % 60;
          sliderValueEl.textContent = m > 0 ? h + "h " + m + "m" : h + "h";
        } else {
          sliderValueEl.textContent = val + "m";
        }
        // Context line
        var plan = calculatePlan();
        if (plan.totalCycles === 0) {
          sliderContext.textContent = "Too short for a focus interval";
        } else {
          var focusTotal = plan.intervals.reduce(function (s, i) {
            return i.type === "work" ? s + i.duration : s;
          }, 0);
          sliderContext.textContent =
            plan.totalCycles + " x " + plan.workMinPerCycle + "min focus" +
            (plan.totalCycles > 1 ? " with breaks" : "");
        }
      }

      // ======== Screen management ========
      function showScreen(name) {
        screenSetup.classList.remove("active");
        screenTimer.classList.remove("active");
        screenComplete.classList.remove("active");
        document.body.className = "";

        if (name === "setup") screenSetup.classList.add("active");
        else if (name === "timer") screenTimer.classList.add("active");
        else if (name === "complete") screenComplete.classList.add("active");
      }

      // ======== Timer engine ========
      function startSession() {
        var plan = calculatePlan();
        if (plan.totalCycles === 0) return;

        savePrefs();

        if ("Notification" in window && Notification.permission === "default") {
          requestNotifPermission();
        }
        try { getAudioCtx().resume(); } catch (e) {}

        session = {
          plan: plan,
          intervals: plan.intervals,
          currentIndex: 0,
          completedCycles: 0,
          totalFocusSeconds: 0,
          totalBreakSeconds: 0,
          sessionStartTime: Date.now(),
          intervalEndTime: 0,
          intervalDuration: 0,
          paused: false,
          pausedRemaining: 0,
          fiveMinWarned: false
        };

        showScreen("timer");
        startInterval(0);
        startTicking();
      }

      function startInterval(index) {
        if (index >= session.intervals.length) {
          finishSession();
          return;
        }

        session.currentIndex = index;
        session.fiveMinWarned = false;
        var interval = session.intervals[index];
        session.intervalDuration = interval.duration * 60;

        if (session.paused) {
          session.pausedRemaining = session.intervalDuration;
        } else {
          session.intervalEndTime = Date.now() + session.intervalDuration * 1000;
        }

        updateBodyState();
        renderCycleDots();
        renderTimerDisplay();

        if (interval.type === "short" || interval.type === "long") {
          var bLabel = interval.type === "long" ? "Long break" : "Short break";
          sendNotif("Time for a break!", bLabel + " \u2014 " + interval.duration + " min");
          playChime("work-end");
        } else if (index > 0) {
          sendNotif("Break\u2019s over!", interval.duration + " minutes of focus time");
          playChime("break-end");
        }
      }

      function updateBodyState() {
        document.body.className = "";
        ringWrap.className = "ring-wrap";
        if (!session) return;
        var timerStage = document.querySelector(".timer-stage");
        if (session.paused) {
          document.body.classList.add("state-paused");
          timerStage.classList.add("paused");
        } else {
          timerStage.classList.remove("paused");
          var interval = session.intervals[session.currentIndex];
          if (interval.type === "work") {
            document.body.classList.add("state-working");
            ringWrap.classList.add("glow-focus");
          } else {
            document.body.classList.add("state-break");
            ringWrap.classList.add("glow-break");
          }
        }
      }

      function getRemainingSeconds() {
        if (!session) return 0;
        if (session.paused) return Math.max(0, session.pausedRemaining);
        return Math.max(0, (session.intervalEndTime - Date.now()) / 1000);
      }

      function startTicking() {
        stopTicking();
        tick();
        tickInterval = setInterval(tick, 250);
      }

      function stopTicking() {
        if (tickInterval) {
          clearInterval(tickInterval);
          tickInterval = null;
        }
      }

      function tick() {
        if (!session) return;

        var remaining = getRemainingSeconds();
        var interval = session.intervals[session.currentIndex];
        var elapsed = session.intervalDuration - remaining;

        // Digits
        timerDigits.textContent = formatTime(remaining);

        // Ring
        var progress = session.intervalDuration > 0 ? elapsed / session.intervalDuration : 0;
        var offset = CIRCUMFERENCE * (1 - progress);
        ringProgress.style.strokeDashoffset = Math.max(0, offset);

        // Ring color + glow
        ringProgress.classList.remove("break", "warning");
        ringWrap.className = "ring-wrap";
        if (session.paused) {
          // no glow
        } else if (interval.type !== "work") {
          ringProgress.classList.add("break");
          ringWrap.classList.add("glow-break");
        } else if (remaining <= 300 && remaining > 0) {
          ringProgress.classList.add("warning");
          ringWrap.classList.add("glow-warning");
        } else {
          ringWrap.classList.add("glow-focus");
        }

        // Tab title
        var stateLabel = interval.type === "work" ? "Focus" : "Break";
        document.title = formatTime(remaining) + " \u2014 " + stateLabel + " | Pomodoro";

        // Timer label
        if (session.paused) {
          timerLabel.textContent = "Paused";
          timerLabel.className = "timer-label paused-label";
        } else if (interval.type === "work") {
          var workNum = 0;
          for (var i = 0; i <= session.currentIndex; i++) {
            if (session.intervals[i].type === "work") workNum++;
          }
          timerLabel.textContent = "Focus " + workNum + " of " + session.plan.totalCycles;
          timerLabel.className = "timer-label focus-label";
        } else {
          timerLabel.textContent = interval.type === "long" ? "Long Break" : "Short Break";
          timerLabel.className = "timer-label break-label";
        }

        // Session progress
        var totalSec = session.plan.totalMinutes * 60;
        var sessElapsed = (Date.now() - session.sessionStartTime) / 1000;
        sessionElapsed.textContent = formatMins(sessElapsed / 60) + " elapsed";
        sessionRemaining.textContent = formatMins(session.plan.totalMinutes) + " total";
        sessionBarFill.style.width = Math.min(100, (sessElapsed / totalSec) * 100) + "%";

        // 5-min warning
        if (!session.paused && interval.type === "work" && !session.fiveMinWarned &&
            session.intervalDuration > 300 && remaining <= 300 && remaining > 0) {
          session.fiveMinWarned = true;
          sendNotif("5 minutes left", "Start wrapping up your current task");
          playChime("warning");
        }

        // Interval complete
        if (!session.paused && remaining <= 0) {
          if (interval.type === "work") {
            session.totalFocusSeconds += session.intervalDuration;
            session.completedCycles++;
          } else {
            session.totalBreakSeconds += session.intervalDuration;
          }
          var nextIdx = session.currentIndex + 1;
          if (nextIdx >= session.intervals.length) {
            finishSession();
          } else {
            beginAutoStart(nextIdx);
          }
        }
      }

      // ======== Auto-start ========
      function beginAutoStart(nextIndex) {
        stopTicking();
        autoStartCountdown = 5;
        var next = session.intervals[nextIndex];
        var label = next.type === "work" ? "Focus" : (next.type === "long" ? "Long Break" : "Break");

        autoStartBar.classList.add("visible");
        renderAutoStart(label);

        autoStartTimeout = setInterval(function () {
          autoStartCountdown--;
          if (autoStartCountdown <= 0) {
            clearInterval(autoStartTimeout);
            autoStartTimeout = null;
            autoStartBar.classList.remove("visible");
            startInterval(nextIndex);
            startTicking();
          } else {
            renderAutoStart(label);
          }
        }, 1000);
      }

      function renderAutoStart(label) {
        autoStartBar.innerHTML = label + " in <strong>" + autoStartCountdown + "s</strong> &nbsp;\u00b7&nbsp; " +
          "<a onclick='window._pomoNow()'>Start now</a> &nbsp;\u00b7&nbsp; " +
          "<a onclick='window._pomoSkipAuto()'>Skip</a>";
      }

      window._pomoNow = function () {
        if (autoStartTimeout) { clearInterval(autoStartTimeout); autoStartTimeout = null; }
        autoStartBar.classList.remove("visible");
        startInterval(session.currentIndex + 1);
        startTicking();
      };

      window._pomoSkipAuto = function () {
        if (autoStartTimeout) { clearInterval(autoStartTimeout); autoStartTimeout = null; }
        autoStartBar.classList.remove("visible");
        var skipIdx = session.currentIndex + 1;
        var nextNext = skipIdx + 1;
        if (nextNext >= session.intervals.length) {
          finishSession();
        } else {
          startInterval(nextNext);
          startTicking();
        }
      };

      // ======== Controls ========
      function togglePause() {
        if (!session) return;
        if (session.paused) {
          session.intervalEndTime = Date.now() + session.pausedRemaining * 1000;
          session.paused = false;
          pauseBtn.textContent = "Pause";
        } else {
          session.pausedRemaining = getRemainingSeconds();
          session.paused = true;
          pauseBtn.textContent = "Resume";
        }
        updateBodyState();
      }

      function skipInterval() {
        if (!session) return;
        if (autoStartTimeout) {
          clearInterval(autoStartTimeout);
          autoStartTimeout = null;
          autoStartBar.classList.remove("visible");
        }
        var interval = session.intervals[session.currentIndex];
        var elapsedSec = session.intervalDuration - getRemainingSeconds();
        if (interval.type === "work") {
          session.totalFocusSeconds += elapsedSec;
          if (elapsedSec > session.intervalDuration * 0.5) session.completedCycles++;
        } else {
          session.totalBreakSeconds += elapsedSec;
        }
        var nextIdx = session.currentIndex + 1;
        if (nextIdx >= session.intervals.length) {
          finishSession();
        } else {
          session.paused = false;
          pauseBtn.textContent = "Pause";
          startInterval(nextIdx);
        }
      }

      function endSession() {
        if (!session) return;
        var interval = session.intervals[session.currentIndex];
        var elapsedSec = session.intervalDuration - getRemainingSeconds();
        if (interval.type === "work") {
          session.totalFocusSeconds += elapsedSec;
          if (elapsedSec > session.intervalDuration * 0.5) session.completedCycles++;
        } else {
          session.totalBreakSeconds += elapsedSec;
        }
        finishSession();
      }

      function finishSession() {
        stopTicking();
        if (autoStartTimeout) { clearInterval(autoStartTimeout); autoStartTimeout = null; }
        autoStartBar.classList.remove("visible");

        var focusMin = Math.round(session.totalFocusSeconds / 60);
        var breakMin = Math.round(session.totalBreakSeconds / 60);
        var cycles = session.completedCycles;

        recordSession(cycles, focusMin);

        // Complete screen
        var messages = ["Nice work!", "Well done!", "Great session!", "Solid focus!"];
        completeTitle.textContent = messages[Math.floor(Math.random() * messages.length)];
        completeSubtitle.textContent = cycles + " pomodoro" + (cycles === 1 ? "" : "s") + " completed";

        completeFocusTime.textContent = formatMins(focusMin);
        completeBreakTime.textContent = formatMins(breakMin);

        var data = loadData();
        var today = data.days[todayKey()];
        completeTodayTotal.textContent = today ? today.pomodoros : cycles;

        document.title = "Done! | Pomodoro";
        sendNotif("Session complete!", cycles + " pomodoro" + (cycles === 1 ? "" : "s") + " \u2014 " + formatMins(focusMin) + " of focus");
        playChime("complete");

        session = null;
        showScreen("complete");
      }

      // ======== Render helpers ========
      function renderCycleDots() {
        if (!session) return;
        var html = "";
        for (var i = 0; i < session.intervals.length; i++) {
          if (session.intervals[i].type !== "work") continue;
          var cls = "dot";
          var worksBefore = 0;
          for (var j = 0; j < i; j++) {
            if (session.intervals[j].type === "work") worksBefore++;
          }
          if (worksBefore < session.completedCycles) {
            cls += " completed";
          } else if (i === session.currentIndex) {
            cls += " current";
          }
          html += '<span class="' + cls + '"></span>';
        }
        cycleDots.innerHTML = html;
      }

      function renderTimerDisplay() {
        if (!session) return;
        timerDigits.textContent = formatTime(getRemainingSeconds());
        ringProgress.style.strokeDashoffset = String(CIRCUMFERENCE);
        ringProgress.classList.remove("break", "warning");
        if (session.intervals[session.currentIndex].type !== "work") {
          ringProgress.classList.add("break");
        }
      }

      function renderTodayStats() {
        var data = loadData();
        var today = data.days[todayKey()];
        var pomos = today ? today.pomodoros : 0;
        var focus = today ? today.focusMinutes : 0;

        if (pomos === 0) {
          todayStatsEl.innerHTML = '<div class="empty-state">No sessions yet today. Ready to focus?</div>';
          streakDotsEl.innerHTML = "";
        } else {
          todayStatsEl.innerHTML =
            '<div class="today-stats">' +
              '<div class="today-count">' + pomos + '</div>' +
              '<div class="today-detail">' +
                '<strong>' + pomos + ' pomodoro' + (pomos === 1 ? '' : 's') + '</strong><br>' +
                formatMins(focus) + ' of focus time' +
              '</div>' +
            '</div>';

          var maxDots = Math.max(pomos, 8);
          var dots = "";
          for (var i = 0; i < maxDots; i++) {
            dots += '<span class="streak-dot' + (i < pomos ? ' filled' : '') + '"></span>';
          }
          streakDotsEl.innerHTML = dots;
        }

        // Recent history
        var keys = Object.keys(data.days).sort().reverse().slice(0, 7);
        if (keys.length > 0) {
          var rows = keys.map(function (key) {
            var d = data.days[key];
            var label = key === todayKey() ? "Today" : key;
            return '<div class="history-row"><span>' + label + '</span><span>' +
              d.pomodoros + ' pom \u00b7 ' + formatMins(d.focusMinutes) + '</span></div>';
          }).join("");
          historyList.innerHTML = rows;
          clearHistoryBtn.style.display = "inline";
        } else {
          historyList.innerHTML = "";
          clearHistoryBtn.style.display = "none";
        }
      }

      // ======== Event listeners ========
      totalSlider.addEventListener("input", updateSlider);
      workDurationInput.addEventListener("input", updateSlider);
      shortBreakInput.addEventListener("input", updateSlider);
      longBreakInput.addEventListener("input", updateSlider);
      longBreakEveryInput.addEventListener("input", updateSlider);

      settingsToggle.addEventListener("click", function () {
        var open = settingsBody.classList.toggle("open");
        settingsToggle.classList.toggle("open");
        settingsToggle.setAttribute("aria-expanded", open ? "true" : "false");
      });

      notifBanner.addEventListener("click", requestNotifPermission);

      startBtn.addEventListener("click", startSession);
      pauseBtn.addEventListener("click", togglePause);
      skipBtn.addEventListener("click", skipInterval);
      endBtn.addEventListener("click", endSession);

      restartBtn.addEventListener("click", function () {
        document.title = originalTitle;
        showScreen("setup");
        renderTodayStats();
      });

      clearHistoryBtn.addEventListener("click", function () {
        var data = loadData();
        data.days = {};
        saveData(data);
        renderTodayStats();
      });

      kbToggle.addEventListener("click", function () {
        kbLegend.classList.toggle("visible");
      });

      document.addEventListener("keydown", function (e) {
        if (e.target.tagName === "INPUT" || e.target.tagName === "SELECT" || e.target.tagName === "TEXTAREA") return;
        if (e.code === "Space" && session) { e.preventDefault(); togglePause(); }
        else if ((e.key === "s" || e.key === "S") && session) { e.preventDefault(); skipInterval(); }
        else if (e.key === "Escape" && session) { e.preventDefault(); endSession(); }
      });

      document.addEventListener("click", function (e) {
        if (e.target !== kbToggle && !kbLegend.contains(e.target)) {
          kbLegend.classList.remove("visible");
        }
      });

      // ======== Init ========
      loadPrefs();
      updateSlider();
      checkNotifPermission();
      renderTodayStats();

    })();
  </script>
</body>
</html>
